// -----------------------------------------------
// グローバル変数 & 設定
// -----------------------------------------------

var DATA_SPREADSHEET_ID = PropertiesService.getScriptProperties().getProperty('SPREADSHEET_ID');
var MASTER_SPREADSHEET_ID = PropertiesService.getScriptProperties().getProperty('MASTER_SPREADSHEET_ID');

var SHEET_NAMES = {
  SETTINGS: '設定',
  EMPLOYEES: '社員マスタ',
  EXPENSE_ITEMS: '経費項目マスタ',
  REPORTS: '経費ヘッダー', 
  EXPENSES: '経費明細',
  TRAVEL_RULES: '出張旅費規定マスタ',
  AREA_MASTER: '宿泊費エリアマスタ',
  POSITION_MASTER: '役職マスタ',
  DEPARTMENT_MASTER: '部門マスタ',
  JOB_TYPE_MASTER: '職種区分マスタ'
};

// -----------------------------------------------
// メイン & 初期化
// -----------------------------------------------

function doGet(e) {
  var ui = HtmlService.createTemplateFromFile('index.html');
  
  var userInfo = getUserInfo_();
  var expenseItems = getSheetData_(SHEET_NAMES.EXPENSE_ITEMS);
  
  var travelRules = getSheetData_(SHEET_NAMES.TRAVEL_RULES);
  var areaMaster = getSheetData_(SHEET_NAMES.AREA_MASTER);
  var positionMaster = getSheetData_(SHEET_NAMES.POSITION_MASTER);
  var departmentMaster = getSheetData_(SHEET_NAMES.DEPARTMENT_MASTER);
  var jobTypeMaster = getSheetData_(SHEET_NAMES.JOB_TYPE_MASTER);
  
  ui.employeeInfo = JSON.stringify(userInfo.employeeInfo);
  ui.isManager = userInfo.isManager;
  ui.expenseItems = JSON.stringify(expenseItems);
  
  ui.travelRules = JSON.stringify(travelRules);
  ui.areaMaster = JSON.stringify(areaMaster);
  ui.positionMaster = JSON.stringify(positionMaster);
  ui.departmentMaster = JSON.stringify(departmentMaster);
  ui.jobTypeMaster = JSON.stringify(jobTypeMaster);

  var pendingCount = 0;
  if (userInfo.isManager) {
    var pendingReports = getPendingReports();
    pendingCount = pendingReports.length;
  }
  ui.pendingCount = pendingCount;
  
  return ui.evaluate()
    .setTitle('経費精算アプリ')
    .addMetaTag('viewport', 'width=device-width, initial-scale=1');
}

function getUserInfo_() {
  var email = Session.getActiveUser().getEmail();
  var data = getSheetData_(SHEET_NAMES.EMPLOYEES);
  
  var userInfo = {
    employeeInfo: {
      id: null, name: 'ゲスト', email: email,
      positionCode: null, deptCode: null, jobTypeCode: null,
      cardId: null, hasCard: false 
    },
    isManager: false
  };
  for (var i = 0; i < data.length; i++) {
    if (data[i]['アドレス'] === email) {
      userInfo.employeeInfo.id = data[i]['社員番号'];
      userInfo.employeeInfo.name = data[i]['社員名'];
      userInfo.employeeInfo.positionCode = data[i]['役職 (コード)'];
      userInfo.employeeInfo.deptCode = data[i]['所属部門 (コード)'];
      userInfo.employeeInfo.jobTypeCode = data[i]['職種区分 (コード)'];
      
      var cardVal = data[i]['カード'];
      if (cardVal) {
        userInfo.employeeInfo.cardId = cardVal;
        userInfo.employeeInfo.hasCard = true;
      }

      var positionName = data[i]['役職名']; 
      if (positionName && (positionName.indexOf('部長') > -1 || positionName.indexOf('課長') > -1)) {
        userInfo.isManager = true;
      }
      break;
    }
  }
  return userInfo;
}

function getSettings_() {
  var cache = CacheService.getScriptCache();
  var CACHE_KEY = 'SETTINGS_CACHE';
  var cached = cache.get(CACHE_KEY);
  if (cached) return JSON.parse(cached);

  var ss = SpreadsheetApp.openById(DATA_SPREADSHEET_ID);
  var sheet = ss.getSheetByName(SHEET_NAMES.SETTINGS);
  if (!sheet || sheet.getLastRow() < 2) return {};
  if (sheet.getLastColumn() < 2) return {}; 

  var data = sheet.getRange(2, 1, sheet.getLastRow() - 1, 2).getValues();
  var settings = {};
  for (var i = 0; i < data.length; i++) {
    if (data[i][0]) settings[data[i][0]] = data[i][1];
  }
  cache.put(CACHE_KEY, JSON.stringify(settings), 21600);
  return settings;
}


// -----------------------------------------------
// (A) 経費精算入力
// -----------------------------------------------

function saveOrSubmitExpenseReport(data, status) {
  var lock = LockService.getScriptLock();
  lock.waitLock(15000); 
  var ss = SpreadsheetApp.openById(DATA_SPREADSHEET_ID);
  var userInfo = getUserInfo_();
  
  try {
    var header = data.header;
    var expenses = data.expenses;
    var reportId = header.reportId;

    if (!reportId) reportId = 'KEIHI-' + Utilities.getUuid();
    
    deleteReportData_(reportId, ss); 
    
    var totalExpenseAmount = 0;
    var allowanceCount = 0;

    for (var k = 0; k < expenses.length; k++) {
      totalExpenseAmount += parseFloat(expenses[k].amount || 0);
      if (String(expenses[k].itemCode) === '101') allowanceCount++;
    }

    if (allowanceCount > 1) throw new Error('日当(101)が複数登録されています。');

    var headerRow = [
      reportId, header.date, userInfo.employeeInfo.name, header.title, header.remarks,
      status, userInfo.employeeInfo.id, totalExpenseAmount,
      (status === '申請中') ? new Date() : null, null
    ];
    
    var expensesRows = expenses.map(function(exp) {
      var expenseId = exp.expenseId;
      if (!expenseId || expenseId.startsWith('temp_')) expenseId = 'EXP-' + Utilities.getUuid();
      
      return [
        reportId, expenseId, exp.itemCode, exp.amount, exp.receiptUrl, exp.remarks,
        exp.useDate, exp.areaCode || null, exp.taxRate, exp.preTaxAmount,
        exp.payee || '', exp.isCard ? '有' : '無', exp.cardUsageAmount || 0
      ];
    });
    
    if (headerRow.length > 0) ss.getSheetByName(SHEET_NAMES.REPORTS).appendRow(headerRow);
    if (expensesRows.length > 0) {
      var expSheet = ss.getSheetByName(SHEET_NAMES.EXPENSES);
      expSheet.getRange(expSheet.getLastRow() + 1, 1, expensesRows.length, expensesRows[0].length).setValues(expensesRows);
    }
    
    if (status === '申請中') {
      var settings = getSettings_();
      var approverEmail = settings.APPROVER_EMAIL_1;
      if (approverEmail) {
        MailApp.sendEmail({
          to: approverEmail,
          subject: '[経費精算] 承認依頼: ' + userInfo.employeeInfo.name + ' (' + header.date + ')',
          body: userInfo.employeeInfo.name + ' さんから経費精算の承認依頼が届きました。\n\n' +
                '日付: ' + header.date + '\n' + '件名: ' + header.title + '\n' +
                '合計経費: ' + totalExpenseAmount + ' 円\n' + '備考: ' + header.remarks + '\n\n' +
                'システムにログインして内容を確認・承認してください。\n' + ScriptApp.getService().getUrl()
        });
      }
    }
    return { status: "success", message: status + "が完了しました。", reportId: reportId };
  } catch (e) {
    Logger.log('saveOrSubmitExpenseReport エラー: ' + e);
    return { status: "error", message: "保存/申請中にエラーが発生しました: " + e.message };
  } finally {
    lock.releaseLock();
  }
}

function uploadBase64Image(base64Image) {
  try {
    var folderId = "1VQgPXronOxngn40uiUVK2eRUPTWSWS4I"; // 本番フォルダID
    var blob = Utilities.newBlob(Utilities.base64Decode(base64Image.split(',')[1]), 'image/png', 'receipt-' + new Date().getTime() + '.png');
    var folder = DriveApp.getFolderById(folderId);
    var file = folder.createFile(blob);
    file.setSharing(DriveApp.Access.DOMAIN_WITH_LINK, DriveApp.Permission.VIEW);
    return { status: "success", url: file.getUrl() };
  } catch (e) {
    Logger.log('uploadBase64Image エラー: ' + e);
    return { status: "error", message: "画像アップロードエラー: " + e.message };
  }
}

function withdrawReport(reportId) {
  var lock = LockService.getScriptLock();
  lock.waitLock(15000);
  try {
    var userInfo = getUserInfo_();
    var userId = userInfo.employeeInfo.id;
    var ss = SpreadsheetApp.openById(DATA_SPREADSHEET_ID);
    var sheet = ss.getSheetByName(SHEET_NAMES.REPORTS);
    if (!sheet || sheet.getLastRow() < 2) throw new Error('データが見つかりません。');
    
    var data = sheet.getRange(1, 1, sheet.getLastRow(), sheet.getLastColumn()).getValues();
    var headers = data[0];
    var reportIdCol = headers.indexOf('経費ID');
    var statusCol = headers.indexOf('承認ステータス');
    var applicantIdCol = headers.indexOf('申請者社員番号');
    var applyDateCol = headers.indexOf('申請日');
    
    if (reportIdCol === -1 || statusCol === -1 || applicantIdCol === -1) throw new Error('必要な列が見つかりません。');
    
    for (var i = 1; i < data.length; i++) {
      if (String(data[i][reportIdCol]) === String(reportId)) {
        if (String(data[i][applicantIdCol]) !== String(userId)) throw new Error('他人の申請を取り下げることはできません。');
        if (data[i][statusCol] !== '申請中') throw new Error('「申請中」以外のステータスは取り下げできません。');
        
        sheet.getRange(i + 1, statusCol + 1).setValue('一時保存');
        if (applyDateCol > -1) sheet.getRange(i + 1, applyDateCol + 1).setValue(null);
        return { status: "success", message: "申請を取り下げ、「一時保存」に戻しました。" };
      }
    }
    throw new Error('対象の申請が見つかりませんでした。');
  } catch(e) {
    Logger.log('withdrawReport Error: ' + e);
    return { status: "error", message: "取り下げ処理エラー: " + e.message };
  } finally {
    lock.releaseLock();
  }
}


// -----------------------------------------------
// (B) (C) 上長・閲覧用
// -----------------------------------------------

function getPendingReports() {
  var data = getSheetData_(SHEET_NAMES.REPORTS);
  var pendingReports = data.filter(function(row) {
    return row['承認ステータス'] === '申請中';
  });
  return pendingReports;
}

function getReportDetails(reportId) {
  try {
    if (!reportId) throw new Error('経費IDが指定されていません。');
    var headerData = getSheetData_(SHEET_NAMES.REPORTS);
    var header = headerData.find(function(row) { return String(row['経費ID']) === String(reportId); });
    
    var expensesData = getSheetData_(SHEET_NAMES.EXPENSES);
    var expenses = expensesData.filter(function(row) { return String(row['経費ID']) === String(reportId); });
    
    var expenseItemsMaster = getSheetData_(SHEET_NAMES.EXPENSE_ITEMS);
    var expenseItemsMap = {};
    expenseItemsMaster.forEach(function(item) { expenseItemsMap[item['経費項目コード']] = item['経費項目']; });

    var areaMaster = getSheetData_(SHEET_NAMES.AREA_MASTER);
    var areaMap = {};
    areaMaster.forEach(function(item) { areaMap[item['地域区分']] = item['地域区分名']; });

    expenses = expenses.map(function(exp) {
      return {
        expenseId: exp['明細ID'], itemCode: exp['経費項目コード'], amount: exp['金額'],
        receiptUrl: exp['領収書URL'], remarks: exp['備考'], useDate: exp['利用日'],
        itemName: expenseItemsMap[exp['経費項目コード']] || exp['経費項目コード'],
        areaCode: exp['エリアコード'], areaName: areaMap[exp['エリアコード']] || '',
        taxRate: exp['消費税率'], preTaxAmount: exp['税抜き金額'],
        payee: exp['支払先'], isCard: (exp['カード利用'] === '有'), cardUsageAmount: exp['カード利用額']
      };
    });
    return { header: header || {}, expenses: expenses };
  } catch (e) {
    Logger.log('getReportDetails エラー: ' + e.message);
    return { header: {}, expenses: [] };
  }
}

function updateReportStatus_(reportId, newStatus, rejectionReason) {
  var lock = LockService.getScriptLock();
  lock.waitLock(15000);
  try {
    var ss = SpreadsheetApp.openById(DATA_SPREADSHEET_ID);
    var sheet = ss.getSheetByName(SHEET_NAMES.REPORTS);
    
    var data = sheet.getRange(1, 1, sheet.getLastRow(), sheet.getLastColumn()).getValues();
    var headers = data[0];
    var reportIdCol = headers.indexOf('経費ID');
    var statusCol = headers.indexOf('承認ステータス');
    var applyDateCol = headers.indexOf('申請日');
    var rejectionReasonCol = headers.indexOf('差戻し理由');
    
    for (var i = 1; i < data.length; i++) {
      if (String(data[i][reportIdCol]) === String(reportId)) {
        sheet.getRange(i + 1, statusCol + 1).setValue(newStatus);
        
        if (newStatus === '差戻し') {
          if (applyDateCol > -1) sheet.getRange(i + 1, applyDateCol + 1).setValue(null);
          if (rejectionReasonCol > -1 && rejectionReason) sheet.getRange(i + 1, rejectionReasonCol + 1).setValue(rejectionReason);
        }
        
        if (newStatus === '承認済' || newStatus === '精算申請済') {
          if (rejectionReasonCol > -1) sheet.getRange(i + 1, rejectionReasonCol + 1).setValue(null);
        }
        
        return { status: "success", message: "ステータスを「" + newStatus + "」に更新しました。" };
      }
    }
    throw new Error('対象の申請データが見つかりません。');
  } catch (e) {
    Logger.log('updateReportStatus_ エラー: ' + e);
    return { status: "error", message: "ステータス更新エラー: " + e.message };
  } finally {
    lock.releaseLock();
  }
}

function approveReport(reportId) {
  var result = updateReportStatus_(reportId, '精算申請済', null);
  
  if (result.status === 'success') {
    try {
      var details = getReportDetails(reportId);
      var header = details.header;
      var settings = getSettings_();
      var accountingEmail = settings.ACCOUNTING_EMAIL;
      
      if (accountingEmail && header) {
        var dateStr = (header['日付'] instanceof Date) ? Utilities.formatDate(header['日付'], Session.getScriptTimeZone(), 'yyyy/MM/dd') : header['日付'];
        MailApp.sendEmail({
          to: accountingEmail,
          subject: '[経費精算] 承認・連携通知: ' + header['申請者'],
          body: header['申請者'] + ' さんの経費精算が承認されました。\n' +
                '経理アプリ側でデータの確認・処理を行ってください。\n\n' +
                '日付: ' + dateStr + '\n' + '件名: ' + header['件名'] + '\n' + '合計経費: ' + header['合計経費'] + ' 円'
        });
      }
      result.message += "\n経理担当者へ連携メールを送信しました。";
    } catch(e) {
      Logger.log('approveReport auto-email error: ' + e);
    }
  }
  return result;
}

function rejectReport(reportId, rejectionReason) { return updateReportStatus_(reportId, '差戻し', rejectionReason); }


// -----------------------------------------------
// (E) 申請一覧用
// -----------------------------------------------

function getMyReports() {
  try {
    var userInfo = getUserInfo_();
    var targetEmployeeId = userInfo.employeeInfo.id;
    if (!targetEmployeeId) return [];

    var allData = getSheetData_(SHEET_NAMES.REPORTS);
    var allExpenses = getSheetData_(SHEET_NAMES.EXPENSES);
    var expenseItemsMaster = getSheetData_(SHEET_NAMES.EXPENSE_ITEMS);
    var areaMaster = getSheetData_(SHEET_NAMES.AREA_MASTER);

    var expenseItemsMap = {};
    expenseItemsMaster.forEach(function(item) { expenseItemsMap[item['経費項目コード']] = item['経費項目']; });
    var areaMap = {};
    areaMaster.forEach(function(item) { areaMap[item['地域区分']] = item['地域区分名']; });

    var expensesByReportId = {};
    allExpenses.forEach(function(exp) {
      var rId = exp['経費ID'];
      if (!expensesByReportId[rId]) expensesByReportId[rId] = [];
      var areaCode = exp['エリアコード'];
      var areaName = areaMap[areaCode] || '';
      var itemName = expenseItemsMap[exp['経費項目コード']] || exp['経費項目コード'];
      
      var rawAmount = exp['金額'] || 0;
      expensesByReportId[rId].push({
        itemName: itemName, 
        areaName: areaName, 
        amount: rawAmount,
        formattedAmount: Number(rawAmount).toLocaleString(), // 3桁区切り
        receiptUrl: exp['領収書URL'], 
        payee: exp['支払先'],
        isCard: (exp['カード利用'] === '有'), 
        cardUsageAmount: exp['カード利用額'],
        useDate: exp['利用日'],
        remarks: exp['備考']
      });
    });

    var idxApplicant = '申請者社員番号';
    var myReports = [];
    for (var i = 0; i < allData.length; i++) {
      if (String(allData[i][idxApplicant]) === String(targetEmployeeId)) {
        var reportId = allData[i]['経費ID'];
        var totalRaw = allData[i]['合計経費'] || 0;
        
        myReports.push({
          '経費ID': reportId, 
          '日付': allData[i]['日付'], 
          '件名': allData[i]['件名'],
          '承認ステータス': allData[i]['承認ステータス'], 
          '合計経費': totalRaw,
          'formattedTotal': Number(totalRaw).toLocaleString(), // 3桁区切り
          '備考': allData[i]['備考'], 
          'details': expensesByReportId[reportId] || []
        });
      }
    }
    
    var statusOrder = { '一時保存': 1, '差戻し': 2, '申請中': 3, '承認済': 4, '精算申請済': 5 };
    myReports.sort(function(a, b) {
      var statusA = statusOrder[a['承認ステータス']] || 99;
      var statusB = statusOrder[b['承認ステータス']] || 99;
      if (statusA !== statusB) return statusA - statusB;
      return (b['日付'] || '').localeCompare(a['日付'] || '');
    });

    return myReports;
  } catch (e) {
    Logger.log('getMyReports エラー: ' + e.message);
    throw new Error('申請一覧の取得に失敗しました: ' + e.message);
  }
}

function getReportDataForEdit(reportId) {
  try {
    var userInfo = getUserInfo_();
    var userId = userInfo.employeeInfo.id;
    var details = getReportDetails(reportId);
    
    if (!details.header || !details.header['経費ID']) return { status: "error", message: "対象の申請データが見つかりません。" };
    if (String(details.header['申請者社員番号']) !== String(userId)) return { status: "error", message: "この申請を編集する権限がありません。" };
    
    var status = details.header['承認ステータス'];
    if (status !== '一時保存' && status !== '差戻し') return { status: "error", message: "「" + status + "」の申請は編集できません。" };
    
    return { status: "success", data: details };
  } catch (e) {
    Logger.log('getReportDataForEdit エラー: ' + e);
    return { status: "error", message: "編集データの読み込みエラー: " + e.message };
  }
}


// -----------------------------------------------
// 汎用ヘルパー関数
// -----------------------------------------------

function getSheetData_(sheetName) {
  var idToUse;
  if (sheetName.indexOf('マスタ') > -1) idToUse = MASTER_SPREADSHEET_ID; else idToUse = DATA_SPREADSHEET_ID;
  if (!idToUse) return [];
  var ss = SpreadsheetApp.openById(idToUse);
  var sheet = ss.getSheetByName(sheetName);
  if (!sheet) return [];
  
  var lastRow = sheet.getLastRow();
  if (lastRow < 2) return [];
  var lastCol = sheet.getLastColumn();
  if (lastCol < 1) return [];
  
  var data = sheet.getRange(1, 1, lastRow, lastCol).getValues();
  var headers = data.shift(); 
  
  var result = data.map(function(row) {
    var obj = {};
    headers.forEach(function(header, index) {
      if (row[index] instanceof Date) {
        try {
          var date = row[index];
          if (date.getFullYear() === 1899 && date.getMonth() === 11 && date.getDate() === 30) obj[header] = Utilities.formatDate(date, Session.getScriptTimeZone(), 'HH:mm');
          else if (date.getHours() === 0 && date.getMinutes() === 0 && date.getSeconds() === 0) obj[header] = Utilities.formatDate(date, Session.getScriptTimeZone(), 'yyyy/MM/dd');
          else obj[header] = Utilities.formatDate(date, Session.getScriptTimeZone(), 'yyyy/MM/dd HH:mm:ss');
        } catch(e) { obj[header] = row[index].toString(); }
      } else obj[header] = row[index];
    });
    return obj;
  });
  return result;
}

function deleteReportData_(reportId, ss) {
  if (!reportId) return;
  if (!ss) ss = SpreadsheetApp.openById(DATA_SPREADSHEET_ID);
  
  [SHEET_NAMES.REPORTS, SHEET_NAMES.EXPENSES].forEach(function(sheetName) {
    var sheet = ss.getSheetByName(sheetName);
    if (!sheet || sheet.getLastRow() < 2) return;
    
    var data = sheet.getRange(1, 1, sheet.getLastRow(), sheet.getLastColumn()).getValues();
    var headers = data[0];
    var reportIdCol = headers.indexOf('経費ID'); 
    if (reportIdCol === -1) reportIdCol = headers.indexOf('日報ID');
    if (reportIdCol === -1) return;
    
    var rowsToDelete = [];
    for (var i = 1; i < data.length; i++) {
      if (String(data[i][reportIdCol]) === String(reportId)) rowsToDelete.push(i + 1);
    }
    rowsToDelete.sort(function(a, b) { return b - a; });
    rowsToDelete.forEach(function(rowNum) { sheet.deleteRow(rowNum); });
  });
}

function clearSettingsCache() {
  CacheService.getScriptCache().remove('SETTINGS_CACHE');
  Browser.msgBox('設定キャッシュをクリアしました。');
}
