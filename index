<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  
  <title>経費精算システム</title>
  <style>
    /* 読み込み中オーバーレイ */
    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      z-index: 9998;
      display: none;
      justify-content: center;
      align-items: center;
    }
    #loading-spinner {
      z-index: 9999;
      color: white;
      text-align: center;
    }

    /* ビュー切り替え */
    .app-view { display: none; }
    .app-view.active { display: block; }

    /* リストアイテム */
    .report-list-item { cursor: pointer; }
    .report-list-item:hover { background-color: #f8f9fa; }
    #E-my-reports-list-body tr { cursor: pointer; }
    
    /* モーダル */
    .modal-backdrop { z-index: 10000; }
    .modal { z-index: 10001; }
    
    /* 上限超過 */
    .amount-over-limit { background-color: #fff3cd; border-color: #ffc107; }

    /* グループヘッダー */
    .status-group-header td {
      background-color: #e9ecef;
      border-top: 2px solid #dee2e6;
      border-bottom: 1px solid #dee2e6;
    }
  </style>
</head>
<body>

  <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="#"><i class="bi bi-wallet2"></i> 経費精算システム</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0" id="nav-links">
          <li class="nav-item">
            <a class="nav-link" href="#" data-view="view-A-expense-report"><i class="bi bi-pencil-square"></i> 経費申請</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" data-view="view-E-my-reports"><i class="bi bi-list-task"></i> 申請一覧</a>
          </li>
          <? if (isManager) { ?>
          <li class="nav-item">
            <a class="nav-link" href="#" data-view="view-B-approval-list">
              <i class="bi bi-check2-circle"></i> 承認待ち <span class="badge bg-danger" id="approval-count-badge"></span>
            </a>
          </li>
          <? } ?>
        </ul>
        <div class="navbar-text text-white">
          <span id="user-info-display"></span> <i class="bi bi-person-circle"></i>
        </div>
      </div>
    </div>
  </nav>

  <div class="container-fluid p-3 p-md-4">

    <div id="view-A-expense-report" class="app-view">
      <h3 class="mb-3"><i class="bi bi-pencil-square"></i> 経費申請・編集</h3>
      <div id="A-rejection-reason" class="alert alert-danger" style="display: none;"></div>

      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <form id="report-header-form">
            <input type="hidden" id="A-reportId">
            <div class="row g-3">
              <div class="col-md-3">
                <label for="A-date" class="form-label">申請日 <span class="text-danger">*</span></label>
                <input type="date" class="form-control" id="A-date" required>
              </div>
              <div class="col-md-5">
                 <label for="A-title" class="form-label">件名 <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="A-title" placeholder="例: 〇〇出張旅費精算" required>
              </div>
              <div class="col-md-4">
                <label for="A-remarks" class="form-label">備考（全体）</label>
                <input type="text" class="form-control" id="A-remarks" placeholder="特記事項など">
              </div>
            </div>
          </form>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>経費明細</span>
          <button type="button" class="btn btn-sm btn-primary" onclick="openExpenseModalA(null)">
            <i class="bi bi-plus-lg"></i> 経費明細を追加
          </button>
        </div>
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>利用日</th>
                <th>経費項目</th>
                <th>エリア</th> 
                <th>金額 (円)</th>
                <th>支払先/カード</th>
                <th style="width: 120px;">領収書</th>
                <th style="width: 80px;">操作</th>
              </tr>
            </thead>
            <tbody id="A-expense-list-body">
              <tr><td colspan="7" class="text-center p-4">「経費明細を追加」ボタンから項目を登録してください。</td></tr>
            </tbody>
            <tfoot class="table-group-divider">
              <tr>
                <td colspan="3" class="text-end fw-bold">合計金額</td>
                <td class="fw-bold text-danger fs-5" id="A-total-expense-amount">0 円</td>
                <td colspan="3"></td>
              </tr>
            </tfoot>
          </table>
        </div>
        <div class="card-footer d-flex justify-content-center gap-3">
          <button type="button" class="btn btn-secondary" onclick="saveOrSubmitExpenseReportA('一時保存')">
            <i class="bi bi-save"></i> 一時保存
          </button>
          <button type="button" class="btn btn-primary" onclick="saveOrSubmitExpenseReportA('申請中')">
            <i class="bi bi-send-check"></i> 申請する
          </button>
          <button type="button" class="btn btn-outline-danger" onclick="resetFormA()">
             <i class="bi bi-arrow-clockwise"></i> 入力リセット
          </button>
        </div>
      </div>
    </div>

    <div id="view-B-approval-list" class="app-view">
      <h3 class="mb-3"><i class="bi bi-check2-circle"></i> 承認待ち一覧</h3>
      <div class="card shadow-sm">
        <div class="list-group list-group-flush" id="B-approval-list-body"></div>
      </div>
    </div>

    <div id="view-C-report-detail" class="app-view">
      <h3 class="mb-3"><i class="bi bi-file-earmark-text"></i> 経費申請 詳細</h3>
      <button class="btn btn-outline-secondary mb-3" id="C-back-button"><i class="bi bi-arrow-left"></i> 戻る</button>

      <div class="card shadow-sm mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
           <h5 class="mb-0" id="C-header-date"></h5>
          <span class="badge fs-6" id="C-header-status-badge"></span>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6"><strong>申請者:</strong> <span id="C-header-applicant"></span></div>
            <div class="col-md-6"><strong>申請日:</strong> <span id="C-header-apply-date"></span></div>
            <div class="col-md-6"><strong>件名:</strong> <span id="C-header-title"></span></div>
            <div class="col-md-6"><strong>合計経費:</strong> <span id="C-header-total-expense" class="text-danger fw-bold"></span> 円</div>
            <div class="col-12 mt-2"><strong>備考:</strong> <pre id="C-header-remarks" class="bg-light p-2 rounded mb-0"></pre></div>
            <div class="col-12 mt-2" id="C-rejection-reason-wrapper" style="display: none;">
              <strong>差戻し理由:</strong>
              <pre id="C-rejection-reason" class="bg-danger-subtle text-danger-emphasis p-2 rounded mb-0"></pre>
            </div>
          </div>
        </div>
      </div>

       <div class="card shadow-sm mb-4">
        <div class="card-header">経費明細</div>
        <div class="table-responsive">
          <table class="table table-striped mb-0">
            <thead class="table-light">
              <tr>
                <th>利用日</th>
                <th>経費項目</th>
                <th>エリア</th> 
                <th>金額 (円)</th>
                <th>支払先/カード</th>
                <th>領収書</th>
              </tr>
            </thead>
            <tbody id="C-expenses-body"></tbody>
          </table>
        </div>
      </div>

      <div id="C-approval-buttons" class="text-center" style="display: none;">
        <input type="hidden" id="C-reportId">
        <button class="btn btn-danger btn-lg" onclick="handleRejectC()"><i class="bi bi-x-circle"></i> 差戻し</button>
        <button class="btn btn-success btn-lg ms-3" onclick="handleApproveC()"><i class="bi bi-check-circle"></i> 承認する</button>
      </div>
    </div>

    <div id="view-E-my-reports" class="app-view">
      <h3 class="mb-3"><i class="bi bi-list-task"></i> 自分の申請履歴</h3>
      <div class="card shadow-sm">
        <div class="card-header">
          <div class="d-flex justify-content-between align-items-center">
             <span>申請履歴</span>
            <button class="btn btn-sm btn-outline-primary" onclick="loadMyReportsE()"><i class="bi bi-arrow-clockwise"></i> 更新</button>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>申請日</th>
                <th>ステータス</th>
                <th>件名</th>
                <th class="text-center">合計経費 (円)</th>
                <th>利用日</th>
                <th>経費項目</th>
                <th class="text-center">経費詳細 (円)</th>
                <th>備考</th>
                <th class="text-center">領収書</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="E-my-reports-list-body"></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
  
  <div id="loading-overlay">
    <div id="loading-spinner">
      <div class="spinner-border" role="status" style="width: 3rem; height: 3rem;"></div>
      <h4 class="mt-3" id="loading-text">読み込み中...</h4>
    </div>
  </div>

  <div class="modal fade" id="expenseModal" tabindex="-1" aria-labelledby="expenseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="expenseModalLabel">経費明細の登録・編集</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
         <div class="modal-body">
          <form id="expense-form">
            <input type="hidden" id="M-expenseId">
            
             <div class="mb-3">
               <label for="M-useDate" class="form-label">利用日 <span class="text-danger">*</span></label>
               <input type="date" class="form-control" id="M-useDate" required>
             </div>
             
             <div class="mb-3">
               <label for="M-itemCode" class="form-label">経費項目 <span class="text-danger">*</span></label>
               <select class="form-select" id="M-itemCode" required>
                 <option value="">選択してください</option>
               </select>
             </div>
    
             <div class="mb-3" id="M-area-wrapper" style="display: none;">
               <label for="M-areaCode" class="form-label">エリア <span class="text-danger">*</span></label>
               <select class="form-select" id="M-areaCode">
                 <option value="">選択してください</option>
                 </select>
             </div>

             <div class="mb-3">
               <label for="M-amount" class="form-label">金額 (円) (税込) <span class="text-danger">*</span></label>
               <input type="number" class="form-control" id="M-amount" required step="any" oninput="calculateTaxA(event)">
               <small id="M-amount-limit-display" class="form-text text-muted"></small>
             </div>

             <div class="mb-3 p-3 bg-light rounded" id="M-card-section" style="display: none;">
               <div class="form-check form-switch">
                 <input class="form-check-input" type="checkbox" id="M-isCard" onchange="onIsCardChangeA()">
                 <label class="form-check-label" for="M-isCard">カード利用</label>
               </div>
               <div id="M-card-amount-wrapper" class="mt-2" style="display: none;">
                 <label for="M-cardUsageAmount" class="form-label">カード利用額 (円)</label>
                 <input type="number" class="form-control" id="M-cardUsageAmount" placeholder="カードで支払った金額">
               </div>
             </div>

             <div class="mb-3">
               <label for="M-taxRateSelect" class="form-label">消費税率</label>
               <div class="input-group">
                 <select class="form-select" id="M-taxRateSelect" onchange="calculateTaxA(event)">
                   <option value="10">10%</option>
                   <option value="8">8%</option>
                   <option value="5">5%</option>
                   <option value="3">3%</option>
                   <option value="0">消費税なし (0%)</option>
                   <option value="other">その他 (手入力)</option>
                 </select>
                 <input type="number" class="form-control" id="M-taxRateInput" placeholder="率(%)" style="display: none;" step="any" oninput="calculateTaxA(event)">
               </div>
             </div>

             <div class="mb-3">
               <label for="M-preTaxAmount" class="form-label">税抜き金額 (円)</label>
               <input type="number" class="form-control" id="M-preTaxAmount" step="any" oninput="calculateTaxA(event)">
             </div>
             
             <div class="mb-3">
               <label for="M-payee" class="form-label">支払先</label>
               <input type="text" class="form-control" id="M-payee" placeholder="例: タクシー (日本交通), 接待 (〇〇亭)">
             </div>

             <div class="mb-3">
               <label for="M-remarks" class="form-label">備考（内容・訪問先など）</label>
                <input type="text" class="form-control" id="M-remarks" placeholder="その他補足事項">
             </div>
             
             <hr class="my-3">
             
             <div class="mb-3">
                <label class="form-label">領収書</label>
                <div>
                  <label class="btn btn-sm btn-outline-primary" for="M-file-upload"><i class="bi bi-upload"></i> 領収書を添付</label>
                  <input type="file" id="M-file-upload" accept="image/*" style="display: none;" onchange="handleFileUploadA(event)">
                </div>
                <div id="M-upload-status" class="mt-2"></div>
             </div>
             
             <div class="mb-3">
                <label for="M-receiptUrl" class="form-label">領収書URL</label>
               <input type="text" class="form-control" id="M-receiptUrl" readonly>
             </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-danger me-auto" id="M-delete-expense" onclick="deleteExpenseItemA()" style="display: none;">
            <i class="bi bi-trash"></i> この明細を削除
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
          <button type="button" class="btn btn-primary" onclick="addExpenseItemA()">
            <i class="bi bi-check-lg"></i> この内容で登録
          </button>
         </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="customAlertModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="customAlertModalLabel">情報</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body"><p id="customAlertMessage"></p></div>
        <div class="modal-footer"><button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="customAlertOkButton">OK</button></div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="customPromptModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
           <h5 class="modal-title" id="customPromptModalLabel">差戻し理由</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <label for="customPromptInput" class="form-label" id="customPromptMessage">差戻し理由を入力してください（必須）:</label>
          <textarea class="form-control" id="customPromptInput" rows="3"></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
           <button type="button" class="btn btn-primary" id="customPromptOkButton">OK</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // --- グローバル変数 ---
    var EMPLOYEE_INFO = <?!= employeeInfo ?>; 
    var IS_MANAGER = <?!= isManager ?>;
    var EXPENSE_ITEMS_MASTER = <?!= expenseItems ?>;
    
    var TRAVEL_RULES_MASTER = <?!= travelRules ?>;
    var AREA_MASTER = <?!= areaMaster ?>;
    var POSITION_MASTER = <?!= positionMaster ?>;
    var DEPARTMENT_MASTER = <?!= departmentMaster ?>;
    var JOB_TYPE_MASTER = <?!= jobTypeMaster ?>;

    var INITIAL_PENDING_COUNT = <?!= pendingCount ?>;
    var AREA_MASTER_MAP = {};
    
    var currentExpenses = []; 
    var expenseModalInstance;
    var viewC_ReturnView = 'view-E-my-reports';
    var customAlertModalInstance;
    var customPromptModalInstance;
    var customAlertCallback = null;
    var customPromptCallback = null;
    var currentExpenseLimit = 0;
    var isCalculatingTax = false;


    // --- 初期化 ---
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('user-info-display').textContent = EMPLOYEE_INFO.name || 'ゲスト';
      if (IS_MANAGER && INITIAL_PENDING_COUNT > 0) {
          document.getElementById('approval-count-badge').textContent = INITIAL_PENDING_COUNT;
      }

      buildNavigation();
      
      expenseModalInstance = new bootstrap.Modal(document.getElementById('expenseModal'));
      document.getElementById('expenseModal').addEventListener('hidden.bs.modal', onExpenseModalHideA);
      
      document.getElementById('M-itemCode').addEventListener('change', onItemCodeChangeA);
      document.getElementById('M-areaCode').addEventListener('change', onAreaCodeChangeA);
      
      initializeCustomModalsA();
      loadExpenseItemsMasterA();
      loadAreaMasterA();
      
      document.getElementById('C-back-button').addEventListener('click', function() { showView(viewC_ReturnView); });
      showView('view-A-expense-report');
    });

    function buildNavigation() {
      var navLinks = document.getElementById('nav-links');
      navLinks.querySelectorAll('.nav-link').forEach(function(link) {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          var viewId = e.currentTarget.dataset.view;
          showView(viewId);
          var navbar = document.getElementById('navbarNav');
          var bsCollapse = bootstrap.Collapse.getInstance(navbar);
           if (bsCollapse && navbar.classList.contains('show')) bsCollapse.hide();
        });
      });
    }

    function loadExpenseItemsMasterA() {
      var select = document.getElementById('M-itemCode');
      select.innerHTML = '<option value="">選択してください</option>';
      EXPENSE_ITEMS_MASTER.forEach(function(item) {
        var option = document.createElement('option');
        option.value = item['経費項目コード'];
        option.textContent = item['経費項目'];
        select.appendChild(option);
      });
    }
    
    function loadAreaMasterA() {
      var select = document.getElementById('M-areaCode');
      select.innerHTML = '<option value="">選択してください</option>';
      AREA_MASTER_MAP = {}; 
      AREA_MASTER.forEach(function(item) {
        var code = item['地域区分'];
        var name = item['地域区分名'];
        var option = document.createElement('option');
        option.value = code;
        option.textContent = name;
        select.appendChild(option);
        AREA_MASTER_MAP[code] = name;
      });
    }

    // --- UI/Helper ---
    function initializeCustomModalsA() {
      var alertModalEl = document.getElementById('customAlertModal');
      customAlertModalInstance = new bootstrap.Modal(alertModalEl);
      alertModalEl.addEventListener('hidden.bs.modal', function() {
        if (typeof customAlertCallback === 'function') { customAlertCallback(); customAlertCallback = null; }
      });
      
      var promptModalEl = document.getElementById('customPromptModal');
      customPromptModalInstance = new bootstrap.Modal(promptModalEl);
      document.getElementById('customPromptOkButton').addEventListener('click', function() {
        var value = document.getElementById('customPromptInput').value;
        if (typeof customPromptCallback === 'function') { customPromptCallback(value); customPromptCallback = null; }
        customPromptModalInstance.hide();
      });
      promptModalEl.addEventListener('hidden.bs.modal', function() {
        if (typeof customPromptCallback === 'function') { customPromptCallback(null); customPromptCallback = null; }
      });
    }
    
    function showCustomAlert(message, callback) {
      document.getElementById('customAlertMessage').textContent = message;
      document.getElementById('customAlertModalLabel').textContent = (message.indexOf('エラー') > -1 || message.indexOf('失敗') > -1) ? 'エラー' : '情報';
      customAlertCallback = callback || null;
      customAlertModalInstance.show();
    }
    
    function showCustomPrompt(message, callback) {
      document.getElementById('customPromptMessage').textContent = message;
      document.getElementById('customPromptInput').value = '';
      customPromptCallback = callback;
      customPromptModalInstance.show();
    }
    
    function showView(viewId) {
      document.querySelectorAll('.app-view').forEach(function(view) { view.classList.remove('active'); });
      document.querySelectorAll('#nav-links .nav-link').forEach(function(link) {
        if (link.dataset.view === viewId) link.classList.add('active'); else link.classList.remove('active');
      });
      var targetView = document.getElementById(viewId);
      if (targetView) {
        targetView.classList.add('active');
        switch (viewId) {
          case 'view-A-expense-report':
            if (!document.getElementById('A-date').value) document.getElementById('A-date').value = getTodayString();
            break;
          case 'view-B-approval-list': loadPendingReportsB(); break;
          // View D is removed
          case 'view-E-my-reports': loadMyReportsE(); break;
        }
      }
    }

    function showLoading(show, text) {
      text = text || '読み込み中...';
      var overlay = document.getElementById('loading-overlay');
      document.getElementById('loading-text').textContent = text;
      overlay.style.display = show ? 'flex' : 'none';
    }

    function onApiError(error) {
      showLoading(false);
      var message = '不明なエラーが発生しました。';
      if (typeof error === 'string') message = error;
      else if (error && error.message) {
        var gasErrorMsg = error.message.split('->').pop();
        message = gasErrorMsg ? gasErrorMsg.trim() : error.message;
      }
      console.error('API Error:', error);
      showCustomAlert('エラーが発生しました:\n' + message);
    }

    function getTodayString() {
      var today = new Date();
      today.setHours(today.getHours() + 9);
      return today.toISOString().split('T')[0];
    }
    
    function formatNumber(num) { return (num || 0).toLocaleString(); }
    
    function formatDateWithDay(dateStr) {
      if (!dateStr) return '日付不明';
      try {
        var date = new Date(dateStr.replace(/-/g, '/'));
        var day = ['日', '月', '火', '水', '木', '金', '土'][date.getDay()];
        var mm = ('0' + (date.getMonth() + 1)).slice(-2);
        var dd = ('0' + date.getDate()).slice(-2);
        return date.getFullYear() + '/' + mm + '/' + dd + ' (' + day + ')';
      } catch (e) { return dateStr; }
    }

    function escapeHTML(str) {
      if (typeof str !== 'string' || !str) return '';
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    }


    // --- (A) 経費申請 ---

    function resetFormA() {
      document.getElementById('report-header-form').reset();
      document.getElementById('A-reportId').value = '';
      document.getElementById('A-date').value = getTodayString();
      document.getElementById('A-rejection-reason').style.display = 'none';
      currentExpenses = [];
      renderExpenseListA();
    }

    function renderExpenseListA() {
      var tbody = document.getElementById('A-expense-list-body');
      tbody.innerHTML = '';
      var totalAmount = 0;

      if (currentExpenses.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4">「経費明細を追加」ボタンから項目を登録してください。</td></tr>';
      } else {
        currentExpenses.forEach(function(ex) {
          var tr = document.createElement('tr');
          var item = EXPENSE_ITEMS_MASTER.find(function(m) { return m['経費項目コード'] === ex.itemCode; });
          var itemName = item ? item['経費項目'] : ex.itemCode;
          var urlLink = ex.receiptUrl ? '<a href="' + ex.receiptUrl + '" target="_blank" rel="noopener noreferrer"><i class="bi bi-box-arrow-up-right"></i></a>' : 'なし';
          var areaName = ex.areaCode ? (AREA_MASTER_MAP[ex.areaCode] || ex.areaCode) : '';

          var extraInfo = escapeHTML(ex.payee || '');
          if (ex.isCard) {
             extraInfo += (extraInfo ? '<br>' : '') + '<span class="badge bg-secondary">Card</span>';
             if (ex.itemCode === '102') extraInfo += ' <small>¥' + formatNumber(ex.cardUsageAmount) + '</small>';
          }

          tr.innerHTML = 
            '<td>' + (ex.useDate || 'N/A') + '</td>' +
            '<td>' + (itemName || '不明') + '</td>' +
            '<td>' + areaName + '</td>' + 
            '<td>' + formatNumber(ex.amount) + '</td>' + 
            '<td><small>' + extraInfo + '</small></td>' + 
            '<td>' + urlLink + '</td>' +
            '<td><button type="button" class="btn btn-sm btn-outline-primary" onclick="openExpenseModalA(\'' + ex.expenseId + '\')"><i class="bi bi-pencil"></i></button></td>';
          
          tbody.appendChild(tr);
          totalAmount += parseFloat(ex.amount) || 0;
        });
      }
      document.getElementById('A-total-expense-amount').textContent = formatNumber(totalAmount) + ' 円';
    }

    function openExpenseModalA(expenseId) {
      document.getElementById('expense-form').reset();
      document.getElementById('M-expenseId').value = '';
      resetModalTravelRuleUI();
      document.getElementById('M-upload-status').innerHTML = '';
      document.getElementById('M-receiptUrl').value = '';
      
      document.getElementById('M-taxRateSelect').value = '10';
      document.getElementById('M-taxRateInput').style.display = 'none';
      document.getElementById('M-preTaxAmount').value = '';
      
      document.getElementById('M-isCard').checked = false;
      document.getElementById('M-card-amount-wrapper').style.display = 'none';
      document.getElementById('M-cardUsageAmount').value = '';

      var deleteButton = document.getElementById('M-delete-expense');
      
      if (expenseId) {
        var expenseToEdit = currentExpenses.find(function(ex) { return ex.expenseId === expenseId; });
        if (expenseToEdit) {
          document.getElementById('M-expenseId').value = expenseToEdit.expenseId;
          document.getElementById('M-useDate').value = expenseToEdit.useDate.replace(/\//g, '-');
          document.getElementById('M-itemCode').value = expenseToEdit.itemCode;
          document.getElementById('M-amount').value = expenseToEdit.amount;
          document.getElementById('M-remarks').value = expenseToEdit.remarks;
          document.getElementById('M-receiptUrl').value = expenseToEdit.receiptUrl;
          document.getElementById('M-areaCode').value = expenseToEdit.areaCode || '';
          document.getElementById('M-preTaxAmount').value = expenseToEdit.preTaxAmount;
          
          document.getElementById('M-payee').value = expenseToEdit.payee || '';
          if (expenseToEdit.isCard) {
            document.getElementById('M-isCard').checked = true;
            document.getElementById('M-cardUsageAmount').value = expenseToEdit.cardUsageAmount;
          }

          var taxRate = expenseToEdit.taxRate;
          var taxSelect = document.getElementById('M-taxRateSelect');
          var taxInput = document.getElementById('M-taxRateInput');
          var standardOptions = ['10', '8', '5', '3', '0'];
          if (taxRate !== undefined && standardOptions.includes(String(taxRate))) {
            taxSelect.value = String(taxRate);
            taxInput.style.display = 'none';
          } else if (taxRate !== undefined) {
            taxSelect.value = 'other';
            taxInput.value = taxRate;
            taxInput.style.display = 'block';
          } else {
            taxSelect.value = '10';
          }

          deleteButton.style.display = 'inline-block';
          updateModalUIOnLoadA();
          
        } else {
           showCustomAlert('エラー: 編集対象の経費が見つかりませんでした。');
           return;
        }
      } else {
        document.getElementById('M-useDate').value = document.getElementById('A-date').value || getTodayString();
        deleteButton.style.display = 'none';
      }
      expenseModalInstance.show();
    }
    
    function onExpenseModalHideA() {
      document.getElementById('expense-form').reset();
      document.getElementById('M-upload-status').innerHTML = '';
      document.getElementById('M-delete-expense').style.display = 'none';
      resetModalTravelRuleUI();
      document.getElementById('M-taxRateInput').style.display = 'none';
    }

    function handleFileUploadA(event) {
      var file = event.target.files[0];
      if (!file) return;
      var reader = new FileReader();
      var statusEl = document.getElementById('M-upload-status');
      reader.onload = function(e) {
        var base64Image = e.target.result;
        statusEl.innerHTML = '<span class="text-primary"><div class="spinner-border spinner-border-sm"></div> アップロード中...</span>';
        showLoading(true, '画像をアップロード中...');
        google.script.run
          .withSuccessHandler(onUploadSuccessA)
          .withFailureHandler(onApiError)
          .uploadBase64Image(base64Image);
      };
      reader.onerror = function() { statusEl.innerHTML = '<span class="text-danger">失敗しました。</span>'; };
      reader.readAsDataURL(file);
      event.target.value = null;
    }
    
    function onUploadSuccessA(result) {
      showLoading(false);
      var statusEl = document.getElementById('M-upload-status');
      if (result.status === 'success' && result.url) {
        statusEl.innerHTML = '<span class="text-success"><i class="bi bi-check-circle-fill"></i> 完了</span>';
        document.getElementById('M-receiptUrl').value = result.url;
      } else {
        onApiError((result && result.message) || '失敗');
        statusEl.innerHTML = '<span class="text-danger">失敗</span>';
      }
    }

    function addExpenseItemA() {
      var form = document.getElementById('expense-form');
      if (!form.checkValidity()) {
        form.classList.add('was-validated');
        showCustomAlert('必須項目を入力してください。');
        return;
      }
      form.classList.remove('was-validated');
      
      var expenseId = document.getElementById('M-expenseId').value;
      var taxRateSelect = document.getElementById('M-taxRateSelect').value;
      var finalTaxRate = (taxRateSelect === 'other') ? (parseFloat(document.getElementById('M-taxRateInput').value) || 0) : parseFloat(taxRateSelect);
      
      var expense = {
        useDate: document.getElementById('M-useDate').value,
        itemCode: document.getElementById('M-itemCode').value,
        amount: parseFloat(document.getElementById('M-amount').value) || 0,
        remarks: document.getElementById('M-remarks').value,
        receiptUrl: document.getElementById('M-receiptUrl').value,
        areaCode: document.getElementById('M-areaCode').value,
        taxRate: finalTaxRate,
        preTaxAmount: parseFloat(document.getElementById('M-preTaxAmount').value) || 0,
        payee: document.getElementById('M-payee').value,
        isCard: document.getElementById('M-isCard').checked,
        cardUsageAmount: document.getElementById('M-isCard').checked ? (parseFloat(document.getElementById('M-cardUsageAmount').value) || 0) : 0
      };

      if (expenseId) {
        expense.expenseId = expenseId;
        var index = currentExpenses.findIndex(function(ex) { return ex.expenseId === expenseId; });
        if (index > -1) currentExpenses[index] = expense; else currentExpenses.push(expense);
      } else {
        expense.expenseId = 'temp_' + Date.now();
        currentExpenses.push(expense);
      }
      
      renderExpenseListA();
      expenseModalInstance.hide();
    }
    
    function deleteExpenseItemA() {
      var expenseId = document.getElementById('M-expenseId').value;
      if (!expenseId) return;
      showCustomAlert('削除します。よろしいですか？', function() {
        currentExpenses = currentExpenses.filter(function(ex) { return ex.expenseId !== expenseId; });
        renderExpenseListA();
        expenseModalInstance.hide();
      });
    }

    function saveOrSubmitExpenseReportA(status) {
      var reportDate = document.getElementById('A-date').value;
      var reportTitle = document.getElementById('A-title').value;
      if (!reportDate || !reportTitle) { showCustomAlert('申請日と件名は必須です。'); return; }
      if (currentExpenses.length === 0) { showCustomAlert('経費明細が1件もありません。'); return; }
      
      var msg = '「' + status + '」で送信します。よろしいですか？' + (status==='申請中'?'\n※申請後は編集できません。':'');
      showCustomAlert(msg, function() {
        showLoading(true, status + '処理を実行中...');
        var data = {
          header: {
             reportId: document.getElementById('A-reportId').value,
            date: reportDate,
            title: reportTitle,
            remarks: document.getElementById('A-remarks').value,
          },
          expenses: currentExpenses
        };
        google.script.run
          .withSuccessHandler(function(result) {
            showLoading(false);
            if (result && result.status === 'success') {
              showCustomAlert(result.message, function() { resetFormA(); showView('view-E-my-reports'); });
            } else onApiError(result ? result.message : '失敗');
          })
           .withFailureHandler(onApiError)
          .saveOrSubmitExpenseReport(data, status);
      });
    }

    // --- 税計算 ---
    function calculateTaxA(event) {
      if (isCalculatingTax) return;
      isCalculatingTax = true;
      try {
        var elId = event.target.id;
        var amountEl = document.getElementById('M-amount');
        var preTaxEl = document.getElementById('M-preTaxAmount');
        var taxSelect = document.getElementById('M-taxRateSelect');
        var taxInput = document.getElementById('M-taxRateInput');

        if (elId === 'M-taxRateSelect') {
           taxInput.style.display = (taxSelect.value === 'other') ? 'block' : 'none';
           if(taxSelect.value === 'other') { isCalculatingTax = false; return; }
        }
        
        var taxRate = (taxSelect.value === 'other') ? (parseFloat(taxInput.value)||0) : parseFloat(taxSelect.value);
        var amount = parseFloat(amountEl.value) || 0;
        var preTaxAmount = parseFloat(preTaxEl.value) || 0;

        if (elId === 'M-taxRateSelect' || elId === 'M-taxRateInput') {
          if (amount > 0) preTaxEl.value = calculatePreTax(amount, taxRate);
        } else if (elId === 'M-preTaxAmount') {
          amountEl.value = calculateAmount(preTaxAmount, taxRate);
        } else if (elId === 'M-amount') {
          preTaxEl.value = calculatePreTax(amount, taxRate);
        }
      } catch (e) { console.error(e); }
      isCalculatingTax = false;
      checkAmountLimitA();
    }
    
    function calculatePreTax(amount, taxRate) {
      if (taxRate < 0) taxRate = 0;
      var rate = 1 + (taxRate / 100);
      return Math.floor((amount / rate) + 1e-9);
    }
    function calculateAmount(preTaxAmount, taxRate) {
      if (taxRate < 0) taxRate = 0;
      return Math.floor(preTaxAmount * (1 + (taxRate / 100)));
    }


    // --- 規定ロジック & カード制御 ---
    function resetModalTravelRuleUI() {
      currentExpenseLimit = 0;
      document.getElementById('M-area-wrapper').style.display = 'none';
      document.getElementById('M-areaCode').required = false;
      document.getElementById('M-areaCode').value = '';
      document.getElementById('M-amount-limit-display').textContent = '';
      document.getElementById('M-amount').classList.remove('amount-over-limit');
      document.getElementById('M-card-section').style.display = 'none';
    }

    function onItemCodeChangeA() {
      var itemCode = document.getElementById('M-itemCode').value;
      var amountInput = document.getElementById('M-amount');
      var areaWrapper = document.getElementById('M-area-wrapper');
      var areaSelect = document.getElementById('M-areaCode');
      var cardSection = document.getElementById('M-card-section');
      
      currentExpenseLimit = 0;
      document.getElementById('M-amount-limit-display').textContent = '';
      amountInput.classList.remove('amount-over-limit');
      areaWrapper.style.display = 'none';
      areaSelect.required = false;

      if (EMPLOYEE_INFO.hasCard) {
        cardSection.style.display = 'block';
        onIsCardChangeA(); 
      } else {
        cardSection.style.display = 'none';
        document.getElementById('M-isCard').checked = false;
        onIsCardChangeA(); 
      }

      if (itemCode === '101') { // 日当
        var allowance = getAllowanceLimitA();
        currentExpenseLimit = allowance;
        amountInput.value = allowance;
        document.getElementById('M-taxRateSelect').value = '0';
        document.getElementById('M-preTaxAmount').value = allowance;
        document.getElementById('M-taxRateInput').style.display = 'none';
        
      } else if (itemCode === '102') { // 宿泊費
        areaWrapper.style.display = 'block';
        areaSelect.required = true;
        if (areaSelect.value) onAreaCodeChangeA();
        else {
           var baseLodging = (getTravelRuleA() || {})['宿泊費'] || 0;
           currentExpenseLimit = parseFloat(baseLodging);
        }
      } else {
        calculateTaxA({ target: { id: 'M-itemCode' } }); 
      }
      checkAmountLimitA();
    }
    
    function onIsCardChangeA() {
      var isCard = document.getElementById('M-isCard').checked;
      var itemCode = document.getElementById('M-itemCode').value;
      var amountWrapper = document.getElementById('M-card-amount-wrapper');
      var cardAmountInput = document.getElementById('M-cardUsageAmount');
      
      if (isCard && itemCode === '102') {
        amountWrapper.style.display = 'block';
        if (!cardAmountInput.value) {
          cardAmountInput.value = document.getElementById('M-amount').value;
        }
      } else {
        amountWrapper.style.display = 'none';
        cardAmountInput.value = ''; 
      }
    }
    
    function onAreaCodeChangeA() {
      if (document.getElementById('M-itemCode').value === '102') updateAccommodationLimitA();
    }
    
    function updateModalUIOnLoadA() {
      onItemCodeChangeA();
      var expenseId = document.getElementById('M-expenseId').value;
      if(expenseId) {
         var ex = currentExpenses.find(function(e){ return e.expenseId === expenseId; });
         if(ex && ex.isCard && EMPLOYEE_INFO.hasCard) {
           document.getElementById('M-isCard').checked = true;
           onIsCardChangeA();
           if (document.getElementById('M-card-amount-wrapper').style.display !== 'none') {
             document.getElementById('M-cardUsageAmount').value = ex.cardUsageAmount;
           }
         }
      }
      checkAmountLimitA();
    }

    function checkAmountLimitA() {
      var amountInput = document.getElementById('M-amount');
      var currentAmount = parseFloat(amountInput.value) || 0;
      if (currentExpenseLimit > 0 && currentAmount > currentExpenseLimit) {
        amountInput.classList.add('amount-over-limit');
      } else {
        amountInput.classList.remove('amount-over-limit');
      }
    }

    function getTravelRuleA() {
       return TRAVEL_RULES_MASTER.find(function(r) {
         return String(r['役職 (コード)']) === String(EMPLOYEE_INFO.positionCode) && 
                String(r['職種区分 (コード)']) === String(EMPLOYEE_INFO.jobTypeCode);
       });
    }
    function getAllowanceLimitA() { return parseFloat((getTravelRuleA() || {})['日当'] || 0); }
    
    function updateAccommodationLimitA() {
      var areaCode = document.getElementById('M-areaCode').value;
      var baseLodging = parseFloat((getTravelRuleA() || {})['宿泊費'] || 0);
      
      if (!areaCode) {
        currentExpenseLimit = baseLodging;
        checkAmountLimitA();
        return;
      }
      var areaRule = AREA_MASTER.find(function(a) { return String(a['地域区分']) === String(areaCode); });
      var additionalLodging = parseFloat((areaRule || {})['追加宿泊費'] || 0);
      var totalLimit = baseLodging + additionalLodging;
      currentExpenseLimit = totalLimit;
      
      document.getElementById('M-amount').value = totalLimit;
      calculateTaxA({ target: { id: 'M-amount' } });
      checkAmountLimitA();
    }


    // --- (B) 承認待ち一覧 ---
    function loadPendingReportsB() {
      showLoading(true, '承認待ち一覧を取得中...');
      google.script.run
        .withSuccessHandler(function(reports) {
          showLoading(false);
          var listBody = document.getElementById('B-approval-list-body');
          var badge = document.getElementById('approval-count-badge');
          listBody.innerHTML = '';
          if (!reports || reports.length === 0) {
            listBody.innerHTML = '<div class="list-group-item">承認待ちの申請はありません。</div>';
            badge.textContent = '';
            return;
          }
          badge.textContent = reports.length;
          reports.sort(function(a, b) { return (a['日付']||'').localeCompare(b['日付']||''); });
          
          reports.forEach(function(r) {
            var item = document.createElement('a');
            item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center report-list-item';
            item.onclick = function() { loadReportDetailsC(r['経費ID'], 'view-B-approval-list'); };
            item.innerHTML = '<div><h5 class="mb-1">'+r['日付']+'</h5><p class="mb-1">'+r['申請者']+'</p><small>'+r['件名']+' (¥'+formatNumber(r['合計経費'])+')</small></div><i class="bi bi-chevron-right"></i>';
            listBody.appendChild(item);
          });
        })
        .withFailureHandler(onApiError)
        .getPendingReports();
    }

    // --- (C) 詳細 ---
    function loadReportDetailsC(reportId, returnViewId) {
      showLoading(true, '詳細を取得中...');
      viewC_ReturnView = returnViewId;
      google.script.run
        .withSuccessHandler(onLoadReportDetailsSuccessC)
        .withFailureHandler(onApiError)
        .getReportDetails(reportId);
    }
    
    function onLoadReportDetailsSuccessC(data) {
      showLoading(false);
      if (!data || !data.header) { onApiError('取得失敗'); return; }
      
      var h = data.header;
      document.getElementById('C-header-date').textContent = formatDateWithDay(h['日付']);
      document.getElementById('C-header-applicant').textContent = h['申請者'];
      document.getElementById('C-header-apply-date').textContent = h['申請日'];
      document.getElementById('C-header-title').textContent = h['件名'];
      document.getElementById('C-header-total-expense').textContent = formatNumber(h['合計経費']);
      document.getElementById('C-header-remarks').textContent = h['備考'] || '';
      document.getElementById('C-header-status-badge').textContent = h['承認ステータス'];
      
      var reasonDiv = document.getElementById('C-rejection-reason-wrapper');
      if (h['差戻し理由']) {
        document.getElementById('C-rejection-reason').textContent = h['差戻し理由'];
        reasonDiv.style.display = 'block';
      } else reasonDiv.style.display = 'none';

      var tbody = document.getElementById('C-expenses-body');
      tbody.innerHTML = '';
      (data.expenses || []).forEach(function(ex) {
         var extra = escapeHTML(ex.payee || '');
         if (ex.isCard) extra += (extra?'<br>':'') + '<span class="badge bg-secondary">Card</span>';
         if (ex.isCard && ex.itemCode === '102') extra += ' <small>¥'+formatNumber(ex.cardUsageAmount)+'</small>';
         
         var url = ex.receiptUrl ? '<a href="'+ex.receiptUrl+'" target="_blank"><i class="bi bi-box-arrow-up-right"></i></a>' : '';
         tbody.innerHTML += '<tr><td>'+ex.useDate+'</td><td>'+(ex.itemName||'')+'</td><td>'+(ex.areaName||'')+'</td><td>'+formatNumber(ex.amount)+'</td><td><small>'+extra+'</small></td><td>'+url+'</td></tr>';
      });

      var btnDiv = document.getElementById('C-approval-buttons');
      if (IS_MANAGER && h['承認ステータス'] === '申請中' && viewC_ReturnView === 'view-B-approval-list') {
        document.getElementById('C-reportId').value = h['経費ID'];
        btnDiv.style.display = 'block';
      } else btnDiv.style.display = 'none';

      showView('view-C-report-detail');
    }

    function handleApproveC() {
      var rid = document.getElementById('C-reportId').value;
      showCustomAlert('承認しますか？\n(承認すると自動で精算申請済となります)', function() {
        showLoading(true, '処理中...');
        google.script.run.withSuccessHandler(function(r) { showLoading(false); showCustomAlert(r.message, function(){ showView('view-B-approval-list'); }); }).withFailureHandler(onApiError).approveReport(rid);
      });
    }
    function handleRejectC() {
      var rid = document.getElementById('C-reportId').value;
      showCustomPrompt('差戻し理由:', function(reason) {
        if(!reason) return;
        showLoading(true, '処理中...');
        google.script.run.withSuccessHandler(function(r) { showLoading(false); showCustomAlert(r.message, function(){ showView('view-B-approval-list'); }); }).withFailureHandler(onApiError).rejectReport(rid, reason);
      });
    }

    // --- (E) 申請一覧 ---
    function loadMyReportsE() {
      showLoading(true, '取得中...');
      google.script.run.withSuccessHandler(onLoadMyReportsSuccessE).withFailureHandler(onApiError).getMyReports();
    }
    function onLoadMyReportsSuccessE(reports) {
      showLoading(false);
      var tbody = document.getElementById('E-my-reports-list-body');
      tbody.innerHTML = '';
      if(!reports || reports.length===0) { tbody.innerHTML='<tr><td colspan="10" class="text-center">なし</td></tr>'; return; }
      
      var currentStatus = "";
      reports.forEach(function(r) {
        if(r['承認ステータス'] !== currentStatus) {
          currentStatus = r['承認ステータス'];
          tbody.innerHTML += '<tr class="status-group-header"><td colspan="10" class="fs-6 fw-bold ps-3 py-2">'+currentStatus+'</td></tr>';
        }
        var badge = '<span class="badge bg-secondary">'+r['承認ステータス']+'</span>';
        if(r['承認ステータス']==='申請中') badge='<span class="badge bg-primary">申請中</span>';
        else if(r['承認ステータス']==='精算申請済') badge='<span class="badge bg-info text-dark">精算申請済</span>';
        else if(r['承認ステータス']==='差戻し') badge='<span class="badge bg-danger">差戻し</span>';
        else if(r['承認ステータス']==='一時保存') badge='<span class="badge bg-warning text-dark">一時保存</span>';

        var btns = '';
        if(r['承認ステータス']==='一時保存' || r['承認ステータス']==='差戻し') {
          btns = '<button class="btn btn-sm btn-primary" onclick="handleEditReportE(\''+r['経費ID']+'\')"><i class="bi bi-pencil"></i> 編集</button>';
        } else if (r['承認ステータス']==='申請中') {
          btns = '<button class="btn btn-sm btn-outline-danger" onclick="handleWithdrawReportE(\''+r['経費ID']+'\')"><i class="bi bi-arrow-counterclockwise"></i> 取り下げ</button>';
        } else {
          btns = '<button class="btn btn-sm btn-outline-secondary" onclick="loadReportDetailsC(\''+r['経費ID']+'\', \'view-E-my-reports\')"><i class="bi bi-eye"></i> 表示</button>';
        }

        var dateHtml = '', itemHtml = '', amountHtml = '', recHtml = '';
        
        (r.details||[]).forEach(function(d){
          dateHtml += (d.useDate || '-') + '<br>';

          var extra = escapeHTML(d.payee || '');
          if(d.isCard) extra += (extra?' ':'') + '[Card]';
          
          var itemText = escapeHTML(d.itemName);
          if(d.areaName) itemText += ' <span class="text-muted">(' + escapeHTML(d.areaName) + ')</span>';
          if(extra) itemText += ' <small class="text-muted">(' + extra + ')</small>';
          
          itemHtml += itemText + '<br>';

          var displayAmount = d.formattedAmount || formatNumber(d.amount);
          // 変更箇所: 数字を囲むdivを追加し、min-widthを指定して右寄せ
          amountHtml += '<div class="d-inline-block text-end" style="min-width: 60px;">' + displayAmount + '</div><br>';

          if(d.receiptUrl) recHtml += '<a href="'+d.receiptUrl+'" target="_blank"><i class="bi bi-box-arrow-up-right"></i></a><br>';
          else recHtml += '-<br>';
        });

        if(!dateHtml) { dateHtml='-'; itemHtml='-'; amountHtml='0'; recHtml='-'; }

        var totalDisplay = r.formattedTotal || formatNumber(r['合計経費']);
        // 変更箇所: 合計金額を囲むdivを追加し、min-widthを指定して右寄せ
        var totalWrapper = '<div class="d-inline-block text-end" style="min-width: 70px;">' + totalDisplay + '</div>';

        var tr = document.createElement('tr');
        tr.innerHTML = 
          '<td>' + (r['日付'] || '') + '</td>' + 
          '<td>' + badge + '</td>' +            
          '<td><small>' + escapeHTML(r['件名']) + '</small></td>' + 
          // 変更箇所: クラスを text-center に変更
          '<td class="text-center fw-bold">' + totalWrapper + '</td>' + 
          '<td><small>' + dateHtml + '</small></td>' +  
          '<td><small>' + itemHtml + '</small></td>' +   
          // 変更箇所: クラスを text-center に変更
          '<td class="text-center"><small>' + amountHtml + '</small></td>' + 
          '<td><small>' + escapeHTML(r['備考']) + '</small></td>' + 
          '<td class="text-center"><small>' + recHtml + '</small></td>' + 
          '<td>' + btns + '</td>'; 
        
        tr.addEventListener('click', function(e) {
          if(!e.target.closest('button') && !e.target.closest('a')) loadReportDetailsC(r['経費ID'], 'view-E-my-reports');
        });
        tbody.appendChild(tr);
      });
    }

    function handleEditReportE(rid) {
      showCustomAlert('編集しますか？', function() {
        showLoading(true);
        google.script.run.withSuccessHandler(onLoadReportForEditSuccessA).withFailureHandler(onApiError).getReportDataForEdit(rid);
      });
    }

    function handleWithdrawReportE(rid) {
      showCustomAlert('申請を取り下げて「一時保存」に戻しますか？', function() {
        showLoading(true, '取り下げ処理中...');
        google.script.run.withSuccessHandler(function(res) {
          showLoading(false);
          if(res.status === 'success') {
            showCustomAlert(res.message, function() { loadMyReportsE(); });
          } else {
            onApiError(res.message);
          }
        }).withFailureHandler(onApiError).withdrawReport(rid);
      });
    }

    function onLoadReportForEditSuccessA(res) {
      showLoading(false);
      if(res.status==='success') {
        resetFormA();
        var h=res.data.header;
        currentExpenses=res.data.expenses||[];
        renderExpenseListA();
        document.getElementById('A-reportId').value=h['経費ID'];
        document.getElementById('A-date').value=h['日付'].replace(/\//g,'-');
        document.getElementById('A-title').value=h['件名'];
        document.getElementById('A-remarks').value=h['備考']||'';
        if(h['差戻し理由']) { document.getElementById('A-rejection-reason').textContent='差戻し理由: '+h['差戻し理由']; document.getElementById('A-rejection-reason').style.display='block'; }
        showView('view-A-expense-report');
      } else onApiError(res.message);
    }
  </script>
</body>
</html>
